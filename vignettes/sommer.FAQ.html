<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Giovanny Covarrubias-Pazaran" />

<meta name="date" content="2019-04-03" />

<title>Frequently asked questions for the sommer package</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; min-height: 1.25em; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; }
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
@media screen {
a.sourceLine::before { text-decoration: underline; color: initial; }
}
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.bn { color: #40a070; } /* BaseN */
code span.fl { color: #40a070; } /* Float */
code span.ch { color: #4070a0; } /* Char */
code span.st { color: #4070a0; } /* String */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.ot { color: #007020; } /* Other */
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.fu { color: #06287e; } /* Function */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code span.cn { color: #880000; } /* Constant */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.ss { color: #bb6688; } /* SpecialString */
code span.im { } /* Import */
code span.va { color: #19177c; } /* Variable */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.op { color: #666666; } /* Operator */
code span.bu { } /* BuiltIn */
code span.ex { } /* Extension */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.at { color: #7d9029; } /* Attribute */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' || rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>

</head>

<body>




<h1 class="title toc-ignore">Frequently asked questions for the sommer package</h1>
<h4 class="author"><em>Giovanny Covarrubias-Pazaran</em></h4>
<h4 class="date"><em>2019-04-03</em></h4>



<p>The sommer package was developed to provide R users a powerful and reliable multivariate mixed model solver. The package is focused in problems of the type p &gt; n (more effects to estimate than observations) and its core algorithm is coded in C++ using the Armadillo library. This package allows the user to fit mixed models with the advantage of specifying the variance-covariance structure for the random effects, and specify heterogeneous variances, and obtain other parameters such as BLUPs, BLUEs, residuals, fitted values, variances for fixed and random effects, etc.</p>
<p>The purpose of this vignette is to provide answers to frequently asked questions (FAQ) related to performance and possible issues:</p>
<div id="i-got-an-error-similar-to" class="section level3">
<h3>1) I got an error similar to:</h3>
<pre class="sourceCode r" id="cb1"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co"># iteration    LogLik     wall    cpu(sec)   restrained</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="co">#     1      -224.676   18:11:23      3           0</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="co"># Sistem is singular. Stopping the job</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="co"># matrix multiplication: incompatible matrix dimensions: 0x0 and ...x...</span></a></code></pre>
<p>This error indicates that your model is singular (phenotypic variance V matrix is not invertible) and therefore the model is stopped throwing the “incompatible matrix dimensions: 0x0 and …x…” error message. Whether you can try a simpler model or just modify the argument <code>tolparinv</code> in the <code>mmer</code> function. The default is 1e-6, which means that it will try to invert V and if it fails it will try to add a small value to the diagonal of V of 1e-6 to make it invertible. If this fails then the program will stop returning that error message which should make you check the quality of your data or model attempted.</p>
<p>Sometimes the model becomes singular when you use variance covariance matrices (i.e. genomic relationship matrices) that are not full-rank. You can try to make it full-rank and try again.</p>
</div>
<div id="my-model-runs-very-slow" class="section level2">
<h2>2) My model runs very slow</h2>
<p>Keep in mind that sommer uses direct inversion (DI) algorithm which can be very slow for large datasets. The package is focused in problems of the type p &gt; n (more random effect levels than observations) and models with dense covariance structures. For example, for experiment with dense covariance structures with low-replication (i.e. 2000 records from 1000 individuals replicated twice with a covariance structure of 1000x1000) sommer will be faster than MME-based software. Also for genomic problems with large number of random effect levels, i.e. 300 individuals (n) with 100,000 genetic markers (p). For highly replicated trials with small covariance structures or n &gt; p (i.e. 2000 records from 200 individuals replicated 10 times with covariance structure of 200x200) asreml or other MME-based algorithms will be much faster and we recommend you to opt for those software.</p>
</div>
<div id="can-i-run-rrblup-for-markers-and-gblup-for-individuals-in-sommer" class="section level2">
<h2>3) Can I run rrBLUP for markers and GBLUP for individuals in sommer</h2>
<p>Both types of models can be fitted in sommer. The only thing that it changes is what is the random effect of interest; the marker matrix or the identifier for the individual.</p>
<pre class="sourceCode r" id="cb2"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">library</span>(sommer)</a></code></pre>
<pre><code>## Loading required package: Matrix</code></pre>
<pre><code>## Loading required package: MASS</code></pre>
<pre><code>## Loading required package: lattice</code></pre>
<pre><code>## Loading required package: crayon</code></pre>
<pre class="sourceCode r" id="cb7"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">## rrBLUP for makers</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="kw">data</span>(DT_cpdata)</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">mix.rrblup &lt;-<span class="st"> </span><span class="kw">mmer</span>(<span class="dt">fixed=</span><span class="kw">cbind</span>(color,Yield)<span class="op">~</span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">                   <span class="dt">random=</span><span class="op">~</span><span class="kw">vs</span>(GT,<span class="dt">Gtc=</span><span class="kw">unsm</span>(<span class="dv">2</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">vs</span>(Rowf,<span class="dt">Gtc=</span><span class="kw">diag</span>(<span class="dv">2</span>)),</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">                   <span class="dt">rcov=</span><span class="op">~</span><span class="kw">vs</span>(units,<span class="dt">Gtc=</span><span class="kw">unsm</span>(<span class="dv">2</span>)), <span class="dt">getPEV =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">                   <span class="dt">data=</span>DT)</a></code></pre>
<pre><code>## iteration    LogLik     wall    cpu(sec)   restrained
##     1      -533.942   19:54:26      5           0
##     2      -373.864   19:54:31      10           0
##     3      -292.05   19:54:35      14           0
##     4      -259.206   19:54:39      18           0
##     5      -255.006   19:54:43      22           0
##     6      -254.802   19:54:47      26           0
##     7      -254.795   19:54:51      30           0
##     8      -254.794   19:54:56      35           0</code></pre>
<pre class="sourceCode r" id="cb9"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">summary</span>(mix.rrblup)</a></code></pre>
<pre><code>## ============================================================
##          Multivariate Linear Mixed Model fit by REML         
## **********************  sommer 3.9  ********************** 
## ============================================================
##          logLik      AIC      BIC Method Converge
## Value -254.7943 513.5886 522.7526     NR     TRUE
## ============================================================
## Variance-Covariance components:
##                       VarComp VarCompSE  Zratio Constraint
## u:GT.color-color    4.183e-06 8.412e-07  4.9727   Positive
## u:GT.color-Yield    2.650e-04 3.458e-04  0.7663   Unconstr
## u:GT.Yield-Yield    5.904e-01 2.594e-01  2.2763   Positive
## u:Rowf.color-color  1.721e-04 1.232e-04  1.3974   Positive
## u:Rowf.Yield-Yield  8.340e+02 3.932e+02  2.1209   Positive
## u:units.color-color 2.464e-03 2.792e-04  8.8280   Positive
## u:units.color-Yield 3.812e-01 2.012e-01  1.8949   Unconstr
## u:units.Yield-Yield 3.239e+03 2.865e+02 11.3051   Positive
## ============================================================
## Fixed effects:
##   Trait      Effect Estimate Std.Error t.value
## 1 color (Intercept)   0.1663   0.03875   4.291
## 2 Yield (Intercept) 132.4217  18.75134   7.062
## ============================================================
## Groups and observations:
##        color Yield
## u:GT    2889  2889
## u:Rowf    13    13
## ============================================================
## Use the '$' sign to access results and parameters</code></pre>
<pre class="sourceCode r" id="cb11"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">## GBLUP for individuals</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">A &lt;-<span class="st"> </span><span class="kw">A.mat</span>(GT)</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">mix.gblup &lt;-<span class="st"> </span><span class="kw">mmer</span>(<span class="dt">fixed=</span><span class="kw">cbind</span>(color,Yield)<span class="op">~</span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">                  <span class="dt">random=</span><span class="op">~</span><span class="kw">vs</span>(id,<span class="dt">Gu=</span>A, <span class="dt">Gtc=</span><span class="kw">unsm</span>(<span class="dv">2</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">vs</span>(Rowf,<span class="dt">Gtc=</span><span class="kw">diag</span>(<span class="dv">2</span>)),</a>
<a class="sourceLine" id="cb11-5" data-line-number="5">                  <span class="dt">rcov=</span><span class="op">~</span><span class="kw">vs</span>(units,<span class="dt">Gtc=</span><span class="kw">unsm</span>(<span class="dv">2</span>)),</a>
<a class="sourceLine" id="cb11-6" data-line-number="6">                  <span class="dt">data=</span>DT)</a></code></pre>
<pre><code>## iteration    LogLik     wall    cpu(sec)   restrained
##     1      -362.46   19:55:27      4           0
##     2      -289.256   19:55:31      8           0
##     3      -259.023   19:55:35      12           0
##     4      -254.901   19:55:39      16           0
##     5      -254.799   19:55:45      22           0
##     6      -254.794   19:55:49      26           0
##     7      -254.794   19:55:53      30           0</code></pre>
<pre class="sourceCode r" id="cb13"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw">summary</span>(mix.gblup)</a></code></pre>
<pre><code>## ============================================================
##          Multivariate Linear Mixed Model fit by REML         
## **********************  sommer 3.9  ********************** 
## ============================================================
##          logLik      AIC      BIC Method Converge
## Value -254.7943 513.5885 522.7526     NR     TRUE
## ============================================================
## Variance-Covariance components:
##                       VarComp VarCompSE  Zratio Constraint
## u:id.color-color    4.918e-03 9.887e-04  4.9742   Positive
## u:id.color-Yield    3.120e-01 4.064e-01  0.7678   Unconstr
## u:id.Yield-Yield    6.940e+02 3.047e+02  2.2774   Positive
## u:Rowf.color-color  1.723e-04 1.235e-04  1.3954   Positive
## u:Rowf.Yield-Yield  8.339e+02 3.931e+02  2.1215   Positive
## u:units.color-color 2.464e-03 2.792e-04  8.8280   Positive
## u:units.color-Yield 3.811e-01 2.012e-01  1.8942   Unconstr
## u:units.Yield-Yield 3.239e+03 2.865e+02 11.3045   Positive
## ============================================================
## Fixed effects:
##   Trait      Effect Estimate Std.Error t.value
## 1 color (Intercept)   0.1823  0.004489   40.60
## 2 Yield (Intercept) 132.3328  8.555778   15.47
## ============================================================
## Groups and observations:
##        color Yield
## u:id     363   363
## u:Rowf    13    13
## ============================================================
## Use the '$' sign to access results and parameters</code></pre>
</div>
<div id="literature" class="section level2">
<h2>Literature</h2>
<p>Covarrubias-Pazaran G. 2016. Genome assisted prediction of quantitative traits using the R package sommer. PLoS ONE 11(6):1-15.</p>
<p>Covarrubias-Pazaran G. 2018. Software update: Moving the R package sommer to multivariate mixed models for genome-assisted prediction. doi: <a href="https://doi.org/10.1101/354639" class="uri">https://doi.org/10.1101/354639</a></p>
<p>Bernardo Rex. 2010. Breeding for quantitative traits in plants. Second edition. Stemma Press. 390 pp.</p>
<p>Gilmour et al. 1995. Average Information REML: An efficient algorithm for variance parameter estimation in linear mixed models. Biometrics 51(4):1440-1450.</p>
<p>Henderson C.R. 1975. Best Linear Unbiased Estimation and Prediction under a Selection Model. Biometrics vol. 31(2):423-447.</p>
<p>Kang et al. 2008. Efficient control of population structure in model organism association mapping. Genetics 178:1709-1723.</p>
<p>Lee, D.-J., Durban, M., and Eilers, P.H.C. (2013). Efficient two-dimensional smoothing with P-spline ANOVA mixed models and nested bases. Computational Statistics and Data Analysis, 61, 22 - 37.</p>
<p>Lee et al. 2015. MTG2: An efficient algorithm for multivariate linear mixed model analysis based on genomic information. Cold Spring Harbor. doi: <a href="http://dx.doi.org/10.1101/027201" class="uri">http://dx.doi.org/10.1101/027201</a>.</p>
<p>Maier et al. 2015. Joint analysis of psychiatric disorders increases accuracy of risk prediction for schizophrenia, bipolar disorder, and major depressive disorder. Am J Hum Genet; 96(2):283-294.</p>
<p>Rodriguez-Alvarez, Maria Xose, et al. Correcting for spatial heterogeneity in plant breeding experiments with P-splines. Spatial Statistics 23 (2018): 52-71.</p>
<p>Searle. 1993. Applying the EM algorithm to calculating ML and REML estimates of variance components. Paper invited for the 1993 American Statistical Association Meeting, San Francisco.</p>
<p>Yu et al. 2006. A unified mixed-model method for association mapping that accounts for multiple levels of relatedness. Genetics 38:203-208.</p>
<p>Abdollahi Arpanahi R, Morota G, Valente BD, Kranis A, Rosa GJM, Gianola D. 2015. Assessment of bagging GBLUP for whole genome prediction of broiler chicken traits. Journal of Animal Breeding and Genetics 132:218-228.</p>
<p>Tunnicliffe W. 1989. On the use of marginal likelihood in time series model estimation. JRSS 51(1):15-27.</p>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
